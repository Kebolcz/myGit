<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../css/ui-box.css">
        <link rel="stylesheet" href="../css/ui-base.css">
        <link rel="stylesheet" href="../css/ui-color.css">
        <link rel="stylesheet" href="../css/appcan.icon.css">
        <link rel="stylesheet" href="../css/appcan.control.css">
    </head>
    <style>
        nav {
            margin: 0;
            padding: .485em 0;
        }
        nav label {
            display: block;
            padding: 0.4em 0.875em;
            text-align: center;
        }
        .width-0333 {
            width: 33.33333333%;
        }
        .width-0900 {
            width: 90%;
        }
        .width-0666 {
            width: 66.66666666%;
        }
        .bb {
            box-sizing: border-box;
        }
        #header {
            background-color: #003b90;
        }
        article {
            font-size: 0.8em;
            color: #ccc;
            text-align: center;
        }
        .beCenter {
            display: -webkit-flex;
            -webkit-justify-content: center;
            -webkit-align-items: center;  
        }
    </style>
    <body class="um-vp " ontouchstart>
        <div id="page_0" class="up ub ub-ver bc-bg" tabindex="0">
            <!--header开始-->
            <div id="header" class="uh bc-text-head ub bc-head">
                <div class="nav-btn ub ub-pc ub-ac" id="nav-left">
                    <div class="fa fa-angle-left fa-2x"></div>
                    <div class="nav-lf umar-l">
                        返回
                    </div>
                </div>
                <h1 class="ut ub-f1 ulev-3 ut-s tx-c" tabindex="0">获取地理位置</h1>
                <div class="nav-btn nav-bt" id="nav-right">

                </div>
            </div>
            <!--header结束-->
            <!--content开始-->
            <div id="content" class="ub-f1 tx-l" style="background: #ffffff;">
                <section>
                    <div class="btns ub">
                        <div class="btn ub-f1 ub-ac bc-text-head ub-pc bc-btn uc-a1 beCenter" style="padding: 0.78em;margin: 0.3em 0.3em"  id="btn2">
                            <div class="uinn3 fa fa-check umh1 umw1"></div>
                            定位
                        </div>
                        <div class="btn ub-f1 ub-ac bc-text-head ub-pc bc-btn uc-a1 beCenter" style="padding: 0.78em;margin: 0.3em 0.3em"  id="btn3">
                            <div class="uinn3 fa fa-check umh1 umw1"></div>
                            确认
                        </div>
                        
                    </div>
                    <article>
                                                                        点击地图控件,可手动修正位置.<br/>
                                                                        点击确认,提交最新位置参数.
                    </article>
                    <div id="locationCode" class="ub ub-pj">
                        <div id="gps"  style="padding:0.3em;margin:0.3em;">
                            <span></span>
                        </div>
                        <div id="corrected" style="margin:0.3em;padding:0.3em">
                            <span></span>
                        </div>
                    </div>
                </section>
            </div>
            <!--content结束-->
        </div>
        <script src="../js/appcan.js"></script>
        <script src="../js/appcan.control.js"></script>
        <script src="../js/app.common.js"></script>
        <script src="../js/app.config.js"></script>
        <script src="../js/wgtHelp.js"></script>
        <script>
            appcan.ready(function() {
                //启用安卓物理按键
                uexWindow.setReportKey(0, 1);
                //监听返回按键
                uexWindow.onKeyPressed = function(keyCode) {
                    //返回键
                    if (keyCode == 0) {
                        appcan.window.close(-1);
                    }
                    //菜单键
                    if (keyCode == 1) {
                    }
                }
                var flag = 1;
                var crtLati = null;
                var crtLongi = null;
                var btnAction = function() {
                    uexLocation.openLocation('bd09');
                    uexLocation.onChange = function(lat, log) {
                    }
                    // var isAndroid = (window.navigator.userAgent.indexOf('Android') >= 0) ? true : false;
                    uexBaiduMap.setCompassEnable(1);
                    uexBaiduMap.onMapClickListener = function(data) {
                        var data = JSON.parse(data);
                        var makerInfo = {
                            makerInfo : {
                                bubble : {
                                    title : "手动修正位置"
                                },
                                latitude : data.latitude,
                                longitude : data.longitude
                            }
                        };
                        uexBaiduMap.hideBubble("10001");
                        var tempStr = JSON.stringify(makerInfo);
                        uexBaiduMap.setMarkerOverlay("10001", tempStr);
                        uexBaiduMap.showBubble("10001");
                        var str = "修正位置:<br>纬度：" + Number(data.latitude).toFixed(8) + "" + '<br>经度：' + Number(data.longitude).toFixed(8);
                        $("#locationCode>#corrected>span").html(str);
                        flag = 0;
                        crtLati = Number(data.latitude).toFixed(8) + "";
                        crtLongi = Number(data.longitude).toFixed(8) + "";;
                    }
                    uexBaiduMap.cbCurrentLocation = function(data) {
                        var jsonData = JSON.parse(data);
                        var lat = jsonData.latitude;
                        var log = jsonData.longitude;
                        var templat = Number(lat).toFixed(8) + "";
                        var templog = Number(log).toFixed(8) + "";
                        
                        crtLati = templat;
                        crtLongi = templog;
                        
                        if (flag == 1) {
                            var str = "GPS位置:<br>纬度：" + templat + '<br>经度：' + templog;
                            $("#locationCode>#gps>span").html(str);
                            var titHeight = $('#header').offset().height + $('#content>section').offset().height;
                            var ra = window.devicePixelRatio;
                            titHeight = Number(titHeight);
                            var viewPort = Number(document.documentElement.clientWidth);
                            var width = Number(viewPort);
                            var height = Number(viewPort) * 0.75;
                            $("#locationCode>#corrected>span").html("");
                            uexBaiduMap.open(0, titHeight, viewPort, height, templog, templat);
                            uexBaiduMap.setZoomLevel(17);
                            uexBaiduMap.setUserTrackingMode(1);
                            var makerInfo = [{
                                id : "10001", //(必选)唯一标识符
                                longitude : templog, //(必选)经度
                                latitude : templat, //(必选)纬度
                                icon : "./icon/btnc.png", //(可选)标注图标路径,支持类型:”res://”“http://”
                                bubble : {//(可选)自定义弹出气泡
                                    title : "GPS定位位置"//(必选)自定义弹出气泡标题
                                }
                            }];
                            var jsonStr = JSON.stringify(makerInfo);
                            uexBaiduMap.addMarkersOverlay(jsonStr);
                            uexBaiduMap.hideBubble("10001");
                            uexBaiduMap.showBubble("10001");
                        } else {
                            //alert(data.latitude+"..."+data.longitude);
                            var makerInfo = {
                                makerInfo : {
                                    bubble : {
                                        title : "GPS定位位置"
                                    },
                                    latitude : templat,
                                    longitude : templog
                                }
                            };
                            uexBaiduMap.hideBubble("10001");
                            var tempStr = JSON.stringify(makerInfo);
                            uexBaiduMap.setMarkerOverlay("10001", tempStr);
                            uexBaiduMap.showBubble("10001");
                            $("#locationCode>#corrected>span").html("");
                        }
                    }
                    uexBaiduMap.getCurrentLocation();
                };
                btnAction();
                appcan.button('#btn2', 'btn-act', function() {
                    $("#locationCode").append();
                    btnAction();
                });
                //确认提交
                appcan.button('#btn3', 'btn-act', function() {
                    console.log('lat:'+crtLati);
                    console.log('long:'+crtLongi);
                    
                    var liIndex = appcan.getLocVal("liIndex");
                    var pageScript = "$('#todo-list>li').eq("+liIndex+").find('.latitude').attr('value','"+crtLati+"');$('#todo-list>li').eq("+liIndex+").find('.latitude').change();";
                    pageScript += "$('#todo-list>li').eq("+liIndex+").find('.longitude').attr('value','"+crtLongi+"');$('#todo-list>li').eq("+liIndex+").find('.longitude').change();";
                    appcan.window.evaluateScript('locationApply', pageScript);
                    appcan.window.close(-1);
                });
                
            });
            appcan.button(".nav-btn", "btn-act", function() {
                appcan.window.close(-1);
            });
        </script>
    </body>
</html>